---
title: Wallace Session `r Sys.Date()`
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
knit_engines$set(asis = function(options) {
  if (options$echo && options$eval) knit_child(text = options$code)
})
knitr::opts_chunk$set(message = FALSE, warning = FALSE, eval = FALSE)
```

```{r vars, include = FALSE, eval = TRUE}
# comp1
occs.db <- "{{occsSource}}" != "user"
occs.user <- "{{occsSource}}" == "user"
```

Please find below the R code history from your *Wallace* v1.0.4 session. 

You can reproduce your session results by running this R Markdown file in RStudio. 

Each code block is called a "chunk", and you can run them either one-by-one or all at once by choosing an option in the "Run" menu at the top-right corner of the "Source" pane in RStudio. 

For more detailed information see <http://rmarkdown.rstudio.com>).

### Package installation

Wallace uses the following R packages that must be installed and loaded before starting.
```{r loadPkgs}
library(spocc)
library(spThin)
library(dismo)
library(rgeos)
library(ENMeval)
```

Wallace also includes several functions developed to help integrate different packages and some additional functionality. For this reason, it is necessary to load the file `functions.R`, The function `system.file()` finds this script, and `source()` loads it.

```{r loadFunctions}
source(system.file('shiny/funcs', 'functions.R', package = 'wallace'))
```

## Record of analysis for *`r "{{spName}}"`*.

```{asis occsTitle}
### Obtain Occurrence Data
```

```{asis, echo = occs.db, eval = occs.db, include = occs.db}
You searched the `r "{{occsSource}}"` database for *`r "{{spName}}"`*, limited to `r {{occsNum}}` records. 
```

```{r occSearch, echo = occs.db, include = occs.db}
# query selected database for occurrence records
db.query <- spocc::occ(query = "{{spName}}", from = "{{occsSource}}", limit = {{occsNum}}, has_coords = TRUE)
# make a formatted version of the species name for spocc
spName <- formatSpName("{{spName}}")
# retrieve data table from spocc object
db.data <- db.query[["{{occsSource}}"]]$data[[spName]]
# remove rows with duplicate coordinates
dupCoords <- duplicated(db.data[c('longitude', 'latitude')])
occs <- db.data[!dupCoords,]
# make sure latitude and longitude are numeric (sometimes they are characters)
occs$latitude <- as.numeric(occs$latitude)
occs$longitude <- as.numeric(occs$longitude)
# give all records a unique ID
occs$occID <- row.names(occs)
# extract occurrence coordinates
occs.xy <- occs[c('longitude', 'latitude')]
```
